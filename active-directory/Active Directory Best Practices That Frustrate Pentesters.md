# Active Directory Best Practices That Frustrate Pentesters
https://www.youtube.com/watch?v=SdNPUhzYTUc
August 13, 2018

## Background
* Active directory practices that pentesting clients do that make BHIS pentester's lives harder
* Mostly about fixing "low hanging fruit"
* No security solutions being sold here

## Amazon
* Really selling Amazon as having lots of security features, but it's super expensive
* Amazon very aggressive about you getting authorization during pentest

## Accounts
* Choosing a good naming convention simplifies overhead & can make life hard
* Ex: first.last-#### (4 random numbers)
* Always implement least privilege (sysadmin has different accounts for different things, not
always logged in as admin)
* There's a service that lets you put a database on that translates between randomly named
for end users and well named for back end
* Groups
  * User groups
  * Security groups
  * Distribution groups
  * Mail enabled security groups
  * Domain Local
  * Global
  * Universal
* Domain local, global, & universal mostly the result of legacy and or acquisition
  * No longer necessary
* JUGULAR
  * Just because it needed to be clever
  * Users
  * Global groups
  * Universal groups
  * Local Access to Resources
* Never give access to a user, only ever groups
* Always apply group policies at the highest level possible: LSD-OU
  * Local -> Site -> Domain -> OU
  * Go down the path if possible (I think?)

## Domain Policies
* Should be as skinny as possible
* Recommended (MS best practice):
  * Password policy:
    * Enforce password history                    -> 24 passwords
    * Maximum password age                        -> 120 days
    * Minimum password age                        -> 1 day(s)
    * Minimum password length                     -> 15 characters
    * Password must meet complexity requirements  -> Disabled (surprising?)
    * Store passwords using reversible encryption -> Disabled (this even exists?)
  * Lockout:
    * Account lockout duration                    -> 30 minutes
    * Account lockout threshold                   -> 4 invalid logon attempts
    * Reset account lockout counter after         -> 30 minutes (different from first?)
* Group Policy Preferences password storage
  * Before 2014 (MS14-025), passwords were stored in GPP
    * Could steal password from GPP
    * Mostly from legacy/upgraded environments
* Server 2016: Defaults still not good enough even if better
  * Password policies
    * Default minimum password length is 7
      * About 35 seconds to completely exhaust keyspace at 229 GHs
  * LLMNR
    * Disable it
      * Computer configuration -> administrative template -> network -> dns client ->
        turn off linklocal name resolution
      * https://www.blackhillsinfosec.com/how-to-disable-llmnr-why-you-want-to/
  * Do not store LANMAN hashes
    * Computer configuration -> policies -> windows settings -> security settings -> local
      policies -> security options -> network security: do not store lan manager hash value on
      next password change: enabled
  * LAPS
    * https://adsecurity.org/?p=3164
    * Stores password in cleartext in protected area, force different passwords for all local admins
    * "No reason not to use, deploy now"
    * Extend schema
      * ms-Mcs-AdmPwd
      * ms-Mcs-AdmPwdExpirationTime
    * Computer configuration -> policies -> software settings -> software installation -> LAPS
  * MFA
  * Defender
    * Need to capture alerts
    * SIEM
    * Customize to environment
    * Code integrity check across the board?
  * Application whitelisting
    * https://www.rootusers.com/implement-applocker-rules/
    * Entirely possible with just AppLocker built in
    * Computer configuration -> Windows settings -> security settings -> Application control
      policies -> AppLocker
    * Yes it can be bypassed, but defense in depth!
  * Powershell & cmd restrictions
    * GPO to restrict PS & PS_ISE by group
    * https://community.spiceworks.com/topic/20844346-been-asked-to-disable-powershell
    * AppLocker -> executable rules -> Deny powershell.exe & powershell_ise.exe by publisher
  * Turn on your host based firewall everywhere
  * Sysmon
    * https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml
    * Monitoring utility for the 21st century
    * During last engagement customer saw everything
    * I believe this has its own talk?
  * Log off inactive users
    * https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/interactive-logon-machine-inactivity-limit
    * https://social.technet.microsoft.com/forums/windows/en-US/d358382c-e91b-4e91-a1e8-04c53cfd91ce
    * It's hard to log off inactive users
    * Bloodhound

## Random
* Put services (such as email) behind VPN to lower password spraying attack surface
* Bitlocker for everything
* Exchange: good god
* Empower your IT support
* Log & analyze icacls into access db, run queries off of it
